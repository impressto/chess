# Nginx configuration for Chess PWA with PHP support
# Add this to your server block

location /chess {
    # Root points to the chess directory (not dist, since index.php is in root)
    root /home/impressto/work/impressto/homeserver/www/homelab;
    
    # Try index.php first, then index.html
    index index.php index.html;
    
    # Try to serve the file directly, fall back to index.php for dynamic content
    try_files $uri $uri/ /chess/index.php?$query_string;
    
    # PHP-FPM configuration for index.php
    location ~ ^/chess/.*\.php$ {
        root /home/impressto/work/impressto/homeserver/www/homelab;
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;  # Adjust PHP version as needed (php7.4, php8.0, php8.2, etc.)
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss image/svg+xml;
    
    # Cache static assets from dist folder (images, fonts, etc.) for 1 year
    location ~* ^/chess/dist/.*\.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        root /home/impressto/work/impressto/homeserver/www/homelab;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Cache CSS and JS from dist folder for 1 year (no hashes now, so version in service-worker.js)
    location ~* ^/chess/dist/.*\.(css|js)$ {
        root /home/impressto/work/impressto/homeserver/www/homelab;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # CRITICAL: Don't cache service worker (needs to update immediately for new versions)
    location = /chess/service-worker.js {
        root /home/impressto/work/impressto/homeserver/www/homelab;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        expires 0;
    }
    
    # Also don't cache service worker in dist (legacy location)
    location = /chess/dist/service-worker.js {
        root /home/impressto/work/impressto/homeserver/www/homelab;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        expires 0;
    }
    
    # Don't cache manifest.json (may change)
    location = /chess/dist/manifest.json {
        root /home/impressto/work/impressto/homeserver/www/homelab;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        expires 0;
    }
    
    # Don't cache index.php or index.html
    location ~ ^/chess/(index\.php|index\.html)$ {
        root /home/impressto/work/impressto/homeserver/www/homelab;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        expires 0;
    }
    
    # Security headers for PWA
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# Note: For HTTPS (required for PWA on production), add SSL configuration:
# 
# listen 443 ssl http2;
# ssl_certificate /path/to/cert.pem;
# ssl_certificate_key /path/to/key.pem;
# ssl_protocols TLSv1.2 TLSv1.3;

#     
#     # ... same caching rules as above but without /chess prefix
# }
