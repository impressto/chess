
server {
    index index.php index.html;
    server_name homelab;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/homelab;

    # Block access to .git and other hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Service worker - no cache headers
    location ~ ^/service-worker\.js$ {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        expires off;
        etag off;
    }
    
    # the MODX part
    location @modx-rewrite {
        rewrite ^/(.*)$ /index.php?q=$1&$args last;
    }

    location / {
        absolute_redirect off;
        try_files $uri $uri/ @modx-rewrite;
    }
    
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
    
    location ~* \.(mp3|m4a|ogg)$ {
        # Only allow requests from your domain
        valid_referers none blocked impressto.ca www.impressto.ca;

        if ($invalid_referer) {
            return 403;
        }
    }
    
    location /chess {
        index index.php index.html;
        try_files $uri $uri/ /chess/index.php?$query_string;
        
        # Security headers for PWA
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
		
	# Required headers for SharedArrayBuffer (Stockfish WASM)
	add_header Cross-Origin-Opener-Policy "same-origin" always;
	add_header Cross-Origin-Embedder-Policy "require-corp" always;
	    
        
        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss image/svg+xml;
        
        # PHP files
        location ~ ^/chess/.*\.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass php-fpm:9000;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            
            # Required headers for SharedArrayBuffer (Stockfish WASM) - must be in PHP location too
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Embedder-Policy "require-corp" always;
        
            expires 0;
        }
        
        # CRITICAL: Don't cache service worker (needs to update immediately for new versions)
        location = /chess/service-worker.js {
            #root /home/impressto/work/impressto/homeserver/www/homelab;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            expires 0;
            # Required headers for SharedArrayBuffer (Stockfish WASM)
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Embedder-Policy "require-corp" always;
        
        }

        # Also don't cache service worker in dist (legacy location)
        location = /chess/dist/service-worker.js {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            expires 0;
            # Required headers for SharedArrayBuffer (Stockfish WASM)
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Embedder-Policy "require-corp" always;
        
        }
        
        # Manifest - don't cache
        location = /chess/dist/manifest.json {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            expires 0;
            # Required headers for SharedArrayBuffer (Stockfish WASM)
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Embedder-Policy "require-corp" always;
        }
        
        # Static assets - cache aggressively
        location ~* ^/chess/dist/.*\.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|css|js|wasm)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
            
            # Required headers for SharedArrayBuffer (Stockfish WASM)
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Embedder-Policy "require-corp" always;
        }
    }
}

server {
    server_name collabrio.ca www.collabrio.ca;

    location / {
        proxy_pass http://127.0.0.1:80/collabrio/index.php;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ESP32 proxy
server {
    listen 80;
    server_name esp32.example.com;

    location / {
        proxy_pass http://192.168.1.50:80;   # ESP32 internal IP
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
